{% extends 'booking/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Gateway RWA — TerraTokenX{% endblock %}

{% block extra_css %}
<style>
    :root {
        --gold-glow: rgba(212, 175, 55, 0.4);
        --bg-black: #050505;
        --panel-bg: #0d0d0d;
        --border-color: #222;
    }

    body { background-color: var(--bg-black); color: #fff; font-family: 'Inter', sans-serif; }

    /* Wizard Steps */
    .step-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
        transition: all 0.3s ease;
        border: 2px solid #333;
        background: #111;
        color: #666;
    }
    .step-active .step-circle {
        background: #d4af37;
        border-color: #d4af37;
        color: #000;
        box-shadow: 0 0 15px var(--gold-glow);
    }
    .step-label { font-size: 0.65rem; font-weight: bold; text-transform: uppercase; color: #666; letter-spacing: 1px; }
    .step-active .step-label { color: #d4af37; }

    /* Asset Selection Card */
    .asset-card {
        background: var(--panel-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 30px;
    }
    .asset-card-header {
        border-bottom: 1px solid var(--border-color);
        padding: 20px 25px;
    }
    .asset-visual {
        background: linear-gradient(180deg, #111 0%, #000 100%);
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border-radius: 8px;
        margin: 20px;
        border: 1px solid #222;
        overflow: hidden;
    }
    .asset-visual img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
    
    .asset-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding: 0 20px;
    }
    .info-box {
        background: #111;
        border: 1px solid #222;
        padding: 15px;
        border-radius: 8px;
    }
    .info-label { font-size: 0.65rem; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }
    .info-value { font-size: 1.4rem; font-weight: bold; }

    /* Quantity Selector */
    .qty-selector {
        background: #111;
        border: 1px solid #333;
        border-radius: 8px;
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 20px;
    }
    .qty-btn {
        background: #222;
        border: none;
        color: #fff;
        width: 40px;
        height: 40px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.2s;
    }
    .qty-btn:hover { background: #d4af37; color: #000; }
    .qty-input {
        background: transparent;
        border: none;
        color: #fff;
        text-align: center;
        flex-grow: 1;
        font-weight: bold;
        font-size: 1.5rem;
        width: 50px;
    }

    /* Coupon Section */
    .coupon-box {
        background: #111;
        border: 1px dashed #333;
        padding: 15px;
        margin: 0 20px 20px 20px;
        border-radius: 8px;
    }

    /* Total Bar */
    .total-bar {
        background: rgba(212, 175, 55, 0.05);
        border-top: 1px solid rgba(212, 175, 55, 0.1);
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    /* Primary Gold Button */
    .btn-gold {
        background: #d4af37;
        color: #000;
        border: none;
        border-radius: 8px;
        padding: 18px;
        font-weight: bold;
        width: calc(100% - 40px);
        margin: 0 20px 20px 20px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.95rem;
    }
    .btn-gold:hover { background: #e5c453; transform: translateY(-2px); box-shadow: 0 5px 20px var(--gold-glow); }
    .btn-gold:disabled { background: #222; color: #555 !important; transform: none; box-shadow: none; cursor: not-allowed; opacity: 0.7; }

    /* Warning Block */
    .separation-block {
        background: rgba(212, 175, 55, 0.03);
        border: 1px solid rgba(212, 175, 55, 0.1);
        padding: 20px;
        margin: 25px 0;
        border-radius: 12px;
    }

    [x-cloak] { display: none !important; }

    /* Custom Input Styles */
    .form-control-custom {
        background: #000;
        border: 1px solid #333;
        color: #fff;
        padding: 15px;
        border-radius: 8px;
        font-size: 1rem;
    }
    .form-control-custom:focus {
        border-color: #d4af37;
        outline: none;
        box-shadow: 0 0 10px rgba(212, 175, 55, 0.1);
    }
    .form-select-custom {
        background-color: #000;
        color: #fff;
        border: 1px solid #333;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="rwaWizard()" x-init="init()" x-cloak>

    <div class="row justify-content-center pt-5">
        <div class="col-lg-7 col-xl-6">

            <!-- Step Indicators -->
            <div class="d-flex justify-content-between mb-5">
                <div class="text-center flex-grow-1" :class="step >= 1 ? 'step-active' : ''">
                    <div class="step-circle mx-auto">1</div>
                    <div class="step-label">Proyecto</div>
                </div>
                <div class="text-center flex-grow-1" :class="step >= 2 ? 'step-active' : ''">
                    <div class="step-circle mx-auto">2</div>
                    <div class="step-label">Identidad</div>
                </div>
                <div class="text-center flex-grow-1" :class="step >= 3 ? 'step-active' : ''">
                    <div class="step-circle mx-auto">3</div>
                    <div class="step-label">Legal</div>
                </div>
                <div class="text-center flex-grow-1" :class="step >= 4 ? 'step-active' : ''">
                    <div class="step-circle mx-auto">4</div>
                    <div class="step-label">Pago</div>
                </div>
            </div>

            <form method="post" id="rwaForm" @submit.prevent="handleSubmit">
                {% csrf_token %}

                <!-- STEP 1: ASSET SELECTION -->
                <div x-show="step === 1" x-transition>
                    <div class="asset-card shadow-2xl">
                        <div class="asset-card-header d-flex justify-content-between align-items-center">
                            <h5 class="m-0 d-flex align-items-center gap-2 font-bold uppercase tracking-wider">
                                <i class="fas fa-building text-gold"></i> Selección del Activo
                            </h5>
                            <!-- Project Selector if multiple -->
                            <div x-show="availableProjects.length > 1">
                                <select class="form-select-custom py-1 px-2 small" x-model="selectedProjectId" @change="updateProject()">
                                    <template x-for="p in availableProjects" :key="p.id">
                                        <option :value="p.id" x-text="p.nombre"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Asset Details Section -->
                        <div class="p-0">
                            <div class="asset-visual">
                                <template x-if="activeProject.imagen">
                                    <img :src="activeProject.imagen">
                                </template>
                                <template x-if="!activeProject.imagen">
                                    <div class="bg-dark w-100 h-100 d-flex align-items-center justify-content-center">
                                        <i class="far fa-image fa-3x text-secondary"></i>
                                    </div>
                                </template>
                                <div class="position-absolute bottom-0 start-0 p-4 w-100" style="background: linear-gradient(0deg, #0d0d0d 0%, transparent 100%);">
                                    <h3 class="text-white fw-bold mb-0" x-text="activeProject.nombre"></h3>
                                    <span class="text-gold small fw-bold uppercase">Reserva de Cupo</span>
                                </div>
                                <input type="hidden" name="proyecto" :value="selectedProjectId">
                            </div>

                            <div class="asset-info-grid">
                                <div class="info-box">
                                    <div class="info-label">PRECIO TOKEN</div>
                                    <div class="info-value text-white">$<span x-text="formatNumber(activeProject.precio)"></span> USD</div>
                                </div>
                                <div class="info-box">
                                    <div class="info-label">RENTABILIDAD</div>
                                    <div class="info-value text-success" x-text="activeProject.rentabilidad"></div>
                                </div>
                            </div>

                            <div class="mt-4 px-4 text-center">
                                <p class="text-muted small mb-2 text-uppercase fw-bold tracking-widest" style="font-size: 0.6rem;">¿Cuántos tokens deseas adquirir?</p>
                            </div>
                            <div class="qty-selector">
                                <button type="button" class="qty-btn" @click="changeQty(-1)"><i class="fas fa-minus"></i></button>
                                <input type="number" name="cantidad_tokens" x-model="qty" @input="calculateTotal()" class="qty-input">
                                <button type="button" class="qty-btn" @click="changeQty(1)"><i class="fas fa-plus"></i></button>
                            </div>

                            <!-- Coupon Input Section -->
                            <div class="coupon-box">
                                <div class="info-label mb-2">¿Tienes un código de descuento?</div>
                                <div class="d-flex gap-2">
                                    <input type="text" name="coupon_code" x-model="couponCode" placeholder="Ingresa tu cupón" 
                                           class="form-control form-control-sm bg-black text-white border-secondary border-opacity-30 flex-grow-1">
                                    <button type="button" @click="validateCoupon()" 
                                            class="btn btn-outline-gold btn-sm px-3 font-bold"
                                            :disabled="!couponCode || isCheckingCoupon">
                                        <span x-show="!isCheckingCoupon">VALIDAR</span>
                                        <span x-show="isCheckingCoupon" class="spinner-border spinner-border-sm"></span>
                                    </button>
                                </div>
                                <div x-show="couponMessage" class="mt-2 small" :class="couponValid ? 'text-success' : 'text-danger'" x-text="couponMessage"></div>
                            </div>

                            <div class="total-bar">
                                <div class="d-flex flex-column">
                                    <span class="text-muted fw-bold small text-uppercase" style="letter-spacing: 1px;">Total a Pagar:</span>
                                    <span x-show="discount > 0" class="text-success x-small fw-bold">DESCUENTO APLICADO</span>
                                </div>
                                <span class="h3 text-gold m-0 font-bold" x-text="'$' + formatNumber(total) + ' USD'"></span>
                            </div>

                            <button type="button" class="btn-gold shadow-lg" @click="step = 2" :disabled="!isStep1Valid">
                                Continuar a Identidad <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <div class="separation-block">
                        <div class="d-flex gap-3">
                            <i class="fas fa-exclamation-circle text-gold fa-lg mt-1"></i>
                            <div>
                                <strong class="text-white d-block mb-1">Ecosistema RWA</strong>
                                <p class="small text-muted mb-0" style="line-height: 1.5;">
                                    Este activo digital es un <strong>Token de Activo (Security Token)</strong>. Su valor está vinculado exclusivamente al rendimiento inmobiliario del proyecto.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: IDENTITY / KYC -->
                <div x-show="step === 2" x-transition x-cloak>
                    <div class="asset-card">
                        <div class="asset-card-header">
                            <h5 class="m-0 uppercase tracking-widest"><i class="fas fa-user-shield text-gold me-2"></i>Tus Datos</h5>
                        </div>
                        <div class="p-4 p-md-5">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="info-label mb-2">NOMBRE COMPLETO</label>
                                    <input type="text" name="nombre" x-model="formData.nombre" class="form-control-custom w-100" placeholder="Ej: Juan Pérez" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="info-label mb-2">EMAIL</label>
                                    <input type="email" name="correo" x-model="formData.correo" class="form-control-custom w-100" placeholder="correo@ejemplo.com" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="info-label mb-2">RUT / ID NACIONAL</label>
                                    <input type="text" name="rut" x-model="formData.rut" class="form-control-custom w-100" placeholder="12.345.678-K" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="info-label mb-2">TELÉFONO</label>
                                    <input type="text" name="telefono" x-model="formData.telefono" class="form-control-custom w-100" placeholder="+56 9 1234 5678" required>
                                </div>
                                <div class="col-md-12">
                                    <label class="info-label mb-2">DIRECCIÓN (Requerido para el contrato)</label>
                                    <input type="text" name="direccion" x-model="formData.direccion" class="form-control-custom w-100" placeholder="Calle, Número, Ciudad" required>
                                </div>

                                <!-- Persona Jurídica Toggle -->
                                <div class="col-md-12 mt-3">
                                    <div class="form-check custom-check">
                                        <input class="form-check-input bg-black border-secondary" type="checkbox" id="es_empresa" name="es_empresa" x-model="isCompany">
                                        <label class="form-check-label small text-muted ms-2" for="es_empresa">
                                            Deseo invertir como Persona Jurídica (Empresa)
                                        </label>
                                    </div>
                                </div>

                                <!-- Campos Empresa (Collapsible) -->
                                <div class="col-md-12" x-show="isCompany" x-transition>
                                    <div class="row g-4 mt-1 p-3 rounded-lg border border-secondary border-opacity-30 bg-black">
                                        <div class="col-md-6">
                                            <label class="info-label mb-2">RAZÓN SOCIAL</label>
                                            <input type="text" name="razon_social" x-model="formData.razon_social" class="form-control-custom w-100" placeholder="Mi Empresa S.A.">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="info-label mb-2">RUT EMPRESA</label>
                                            <input type="text" name="rut_empresa" x-model="formData.rut_empresa" class="form-control-custom w-100" placeholder="76.123.456-7">
                                        </div>
                                        <div class="col-md-12">
                                            <label class="info-label mb-2">CARGO REPRESENTANTE</label>
                                            <input type="text" name="cargo_representante" x-model="formData.cargo_representante" class="form-control-custom w-100" placeholder="Ej: Gerente General">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 d-flex gap-3">
                            <button type="button" class="btn btn-outline-secondary flex-grow-1 p-3 rounded-lg font-bold" @click="step = 1">ATRÁS</button>
                            <button type="button" class="btn-gold flex-grow-1 m-0" @click="validateStep2AndProceed()" :disabled="!isStep2Valid">
                                SIGUIENTE
                            </button>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: LEGAL -->
                <div x-show="step === 3" x-transition x-cloak>
                    <div class="asset-card">
                        <div class="asset-card-header">
                            <h5 class="m-0 uppercase tracking-widest"><i class="fas fa-file-contract text-gold me-2"></i>Legal & T&C</h5>
                        </div>
                        <div class="p-4 p-md-5 text-center">
                            <div class="bg-black p-4 rounded-lg border border-secondary mb-5">
                                <div class="text-muted small uppercase mb-1">Total Reserva</div>
                                <div class="h2 text-gold font-bold" x-text="'$' + formatNumber(total) + ' USD'"></div>
                            </div>

                            <div class="text-start space-y-4">
                                <div class="form-check mb-4 custom-check">
                                    <input class="form-check-input bg-black border-secondary" type="checkbox" id="terms" required x-model="tcAccepted">
                                    <label class="form-check-label small text-muted ms-2" for="terms">
                                        He leído y acepto los <a href="#" class="text-gold text-decoration-none">Términos de Inversión</a> y la <a href="#" class="text-gold text-decoration-none">Política de Privacidad</a>.
                                    </label>
                                </div>
                                <div class="form-check mb-4 custom-check">
                                    <input class="form-check-input bg-black border-secondary" type="checkbox" id="eligibility" required x-model="eligibleAccepted">
                                    <label class="form-check-label small text-muted ms-2" for="eligibility">
                                        Declaro bajo juramento la licitud de los fondos y cumplimiento de elegibilidad.
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 d-flex gap-3">
                            <button type="button" class="btn btn-outline-secondary flex-grow-1 p-3 rounded-lg font-bold" @click="step = 2">ATRÁS</button>
                            <button type="button" class="btn-gold flex-grow-1 m-0" @click="step = 4" :disabled="!isStep3Valid">CONTINUAR AL PAGO</button>
                        </div>
                    </div>
                </div>

                <!-- STEP 4: PAYMENT -->
                <div x-show="step === 4" x-transition x-cloak>
                    <div class="asset-card">
                        <div class="asset-card-header text-center">
                            <h5 class="m-0 uppercase tracking-widest">Gateway de Pago</h5>
                        </div>
                        <div class="p-4 p-md-5">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="w-100 cursor-pointer">
                                        <input type="radio" name="metodo_pago" value="MP" class="d-none" x-model="paymentMethod">
                                        <div class="p-4 text-center rounded-lg border-2 transition-all h-100 d-flex flex-column align-items-center justify-content-center"
                                             :class="paymentMethod === 'MP' ? 'border-gold bg-dark' : 'border-secondary bg-black'">
                                            <i class="fas fa-credit-card fa-2x mb-3 text-primary"></i>
                                            <div class="fw-bold text-white uppercase" style="font-size: 0.8rem;">Mercado Pago</div>
                                            <div class="x-small text-muted mt-1" style="font-size: 0.6rem;">FIAT (TARJETAS)</div>
                                        </div>
                                    </label>
                                </div>
                                <div class="col-md-6">
                                    <label class="w-100 cursor-pointer">
                                        <input type="radio" name="metodo_pago" value="CRYPTO" class="d-none" x-model="paymentMethod">
                                        <div class="p-4 text-center rounded-lg border-2 transition-all h-100 d-flex flex-column align-items-center justify-content-center"
                                             :class="paymentMethod === 'CRYPTO' ? 'border-gold bg-dark' : 'border-secondary bg-black'">
                                            <i class="fab fa-bitcoin fa-2x mb-3 text-warning"></i>
                                            <div class="fw-bold text-white uppercase" style="font-size: 0.8rem;">Criptomonedas</div>
                                            <div class="x-small text-muted mt-1" style="font-size: 0.6rem;">USDT / BTC / ETH</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 d-flex gap-3">
                            <button type="button" class="btn btn-outline-secondary flex-grow-1 p-3 rounded-lg font-bold" @click="step = 3">ATRÁS</button>
                            <button type="submit" class="btn-gold flex-grow-1 m-0">FINALIZAR COMPRA</button>
                        </div>
                    </div>
                </div>

            </form>

        </div>
    </div>
</div>

<style>
    .btn-outline-gold {
        color: #d4af37;
        border-color: #d4af37;
    }
    .btn-outline-gold:hover {
        background-color: #d4af37;
        color: #000;
    }
    .hover-gold:hover { color: #d4af37 !important; }
    .x-small { font-size: 0.75rem; }
    .custom-check .form-check-input:checked { background-color: #d4af37; border-color: #d4af37; }
    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
</style>

<!-- Data for Projects -->
<script id="projects-json" type="application/json">
[
    {% for p in proyectos_activos %}
    {
        "id": "{{ p.id }}",
        "nombre": "{{ p.nombre|escapejs }}",
        "precio": {{ p.precio_token|default:100 }},
        "rentabilidad": "{{ p.rentabilidad_estimada|escapejs }}",
        "imagen": "{{ p.imagen_portada_url|default:'' }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<script>
    function rwaWizard() {
        return {
            step: 1,
            qty: 1,
            total: 0,
            tcAccepted: false,
            eligibleAccepted: false,
            paymentMethod: 'MP',
            isCompany: false,
            
            // Project selection
            availableProjects: [],
            selectedProjectId: null,
            activeProject: {},

            // Form data for validation
            formData: {
                nombre: '{% if user.is_authenticated %}{{ user.first_name }} {{ user.last_name }}{% endif %}',
                correo: '{% if user.is_authenticated %}{{ user.email }}{% endif %}',
                rut: '',
                telefono: '',
                direccion: '',
                razon_social: '',
                rut_empresa: '',
                cargo_representante: ''
            },
            
            // Coupon state
            couponCode: '',
            isCheckingCoupon: false,
            couponValid: false,
            couponMessage: '',
            discount: 0,
            
            init() {
                // Initialize projects
                const dataRaw = document.getElementById('projects-json').textContent;
                this.availableProjects = JSON.parse(dataRaw);
                
                // Determine initial project
                const urlParams = new URLSearchParams(window.location.search);
                const projectSlug = urlParams.get('project_slug');
                
                {% if proyecto %}
                this.selectedProjectId = "{{ proyecto.id }}";
                {% else %}
                if (this.availableProjects.length > 0) {
                    this.selectedProjectId = this.availableProjects[0].id;
                }
                {% endif %}
                
                this.updateProject();
            },

            updateProject() {
                this.activeProject = this.availableProjects.find(p => p.id == this.selectedProjectId) || this.availableProjects[0] || {};
                this.calculateTotal();
            },

            changeQty(delta) {
                this.qty = Math.max(1, parseInt(this.qty) + delta);
                this.calculateTotal();
            },

            calculateTotal() {
                const subtotal = (this.activeProject.precio || 0) * this.qty;
                if (this.discount > 0) {
                    this.total = subtotal - (subtotal * this.discount / 100);
                } else {
                    this.total = subtotal;
                }
            },

            async validateCoupon() {
                if (!this.couponCode) return;
                this.isCheckingCoupon = true;
                this.couponMessage = '';
                try {
                    const response = await fetch('/validate-coupon/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ code: this.couponCode })
                    });
                    const data = await response.json();
                    if (data.valid) {
                        this.couponValid = true;
                        this.discount = data.discount_percentage;
                        this.couponMessage = data.message;
                        this.calculateTotal();
                    } else {
                        this.couponValid = false;
                        this.discount = 0;
                        this.couponMessage = data.message;
                        this.calculateTotal();
                    }
                } catch (error) {
                    this.couponMessage = 'Error al validar cupón.';
                } finally {
                    this.isCheckingCoupon = false;
                }
            },

            // Validation Getters
            get isStep1Valid() {
                return this.selectedProjectId && this.qty >= 1;
            },

            get isStep2Valid() {
                const basic = this.formData.nombre && this.formData.correo.includes('@') && this.formData.rut && this.formData.telefono && this.formData.direccion;
                if (!this.isCompany) return basic;
                return basic && this.formData.razon_social && this.formData.rut_empresa && this.formData.cargo_representante;
            },

            get isStep3Valid() {
                return this.tcAccepted && this.eligibleAccepted;
            },

            validateStep2AndProceed() {
                if (this.isStep2Valid) {
                    this.step = 3;
                } else {
                    alert("Por favor completa todos los campos requeridos.");
                }
            },

            formatNumber(num) {
                if (!num) return "0";
                return Math.round(num).toLocaleString('en-US');
            },

            handleSubmit() {
                document.getElementById('rwaForm').submit();
            }
        }
    }
</script>
{% endblock %}