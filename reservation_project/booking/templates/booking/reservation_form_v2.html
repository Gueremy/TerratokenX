{% load static humanize %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>TerraTokenX - Reserva token</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: {
                            400: '#E5C453',
                            500: '#D4AF37',
                            600: '#B5952F',
                        },
                        dark: {
                            800: '#121212',
                            900: '#050505',
                            card: '#1e1e1e'
                        }
                    }
                }
            }
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Custom Scrollbar for Dark Theme */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #D4AF37;
        }

        /* General Input Styling for Dark Mode */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            background-color: #121212 !important;
            border: 1px solid #333 !important;
            color: #f3f4f6 !important;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #D4AF37 !important;
            outline: none;
            box-shadow: 0 0 0 1px #D4AF37;
        }

        /* Specific override if needed for coupon, though general rule covers it */
        input[name="coupon_code"] {
            border-color: #D4AF37 !important;
        }
    </style>
    <script>
        function formatearCLP(valor) {
            return '$' + valor.toLocaleString('es-CL');
        }
    </script>
</head>

<body class="text-gray-100 font-sans antialiased selection:bg-gold-500 selection:text-black"
    style="background: linear-gradient(to top right, #000000, #374151); min-height: 100vh;">

    <!-- Icono de acceso para administradores -->
    <a href="{% url 'login' %}" title="Acceso Administrador"
        class="fixed top-4 left-4 text-gray-500 hover:text-gold-500 transition-colors z-10">
        <span class="material-icons" style="font-size: 32px;">
            account_circle
        </span>
    </a>

    <div class="container mx-auto px-2 py-6 sm:px-4 sm:py-8 max-w-3xl">
        <!-- Mensaje Importante -->

        <div class="flex flex-col items-center justify-center mb-6">
            <img src="{% static 'booking/img/Terratoken_logo-removebg-preview2.png' %}" alt="TerraTokenX Logo"
                class="w-72 sm:w-80 h-auto object-contain mb-2">
            <p class="text-gray-500 text-xs sm:text-sm uppercase tracking-widest font-medium">Reserva de Cupo de
                Inversión</p>
        </div>
        <!-- Mensaje para el usuario -->
        <div id="mensaje-usuario" style="display:none;"
            class="mb-4 text-center px-4 py-2 bg-red-900 text-red-100 border border-red-700 rounded"></div>
        {% if messages %}
        <ul>
            {% for message in messages %}
            <li class="text-red-400 mb-2">{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        <div class="bg-dark-800 p-4 sm:p-6 rounded-lg shadow-2xl border border-gray-800 max-w-lg mx-auto w-full">
            <form id="reserva-form" method="post" novalidate>
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Nombre completo*</label>
                        {{ form.nombre }}
                        {{ form.nombre.errors }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Correo electrónico*</label>
                        {{ form.correo }}
                        {{ form.correo.errors }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Teléfono*</label>
                        {{ form.telefono }}
                        {{ form.telefono.errors }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Dirección*</label>
                        {{ form.direccion }}
                        {{ form.direccion.errors }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">{{ form.coupon_code.label }}</label>
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-gold-500">local_offer</span>
                            <div class="flex-1">
                                {{ form.coupon_code }}
                                {{ form.coupon_code.errors }}
                            </div>
                            <button type="button" id="btn-validar-cupon"
                                class="px-3 py-2 bg-dark-700 border border-gold-500 text-gold-500 rounded hover:bg-gold-500 hover:text-black transition-colors text-sm font-bold">
                                Validar
                            </button>
                        </div>
                        <small id="coupon-message" class="text-gray-500 block mt-1 h-5"></small>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Cantidad de Tokens</label>
                        {{ form.cantidad_tokens }}
                        {{ form.cantidad_tokens.errors }}
                    </div>
                </div>

                <!-- Sección de Precios Mejorada -->
                <div id="precio-info" class="mt-6 bg-dark-700 border border-gray-700 p-4 rounded-lg">
                    <div class="flex justify-between items-center text-sm mb-1 text-gray-400">
                        <span id="precio-dia-label">Valor del Token</span>
                        <span class="font-semibold text-gray-300">${{ precio_base_token|intcomma }}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm mb-1 text-gray-400">
                        <span>Cantidad</span>
                        <span id="cantidad-display" class="font-semibold text-gray-300">1</span>
                    </div>

                    <!-- Fila de Descuento (Oculta por defecto) -->
                    <div id="row-descuento"
                        class="flex justify-between items-center text-sm mb-1 text-green-400 hidden">
                        <span>Descuento (<span id="discount-percent">0</span>%)</span>
                        <span id="discount-amount" class="font-semibold">-$0</span>
                    </div>

                    <div
                        class="flex justify-between items-center text-lg font-bold text-gold-400 mt-2 border-t border-gray-600 pt-2">
                        <span>Total a Pagar</span>
                        <span id="precio-total">${{ precio_base_token|intcomma }}</span>
                    </div>
                </div>



                <!-- Selector de Medio de Pago -->
                <div class="mt-8 mb-6">
                    <h3 class="text-lg font-semibold text-gold-400 mb-4 border-b border-gray-700 pb-2">Selecciona Método
                        de Pago</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Opción Mercado Pago -->
                        <label class="cursor-pointer relative group">
                            <input type="radio" name="metodo_pago" value="MP" class="peer sr-only" checked>
                            <div
                                class="p-4 rounded-lg border-2 border-gray-700 bg-dark-700 hover:border-gold-500/50 peer-checked:border-gold-500 peer-checked:bg-gold-500/10 transition-all duration-200 flex flex-col items-center">
                                <span
                                    class="material-icons text-blue-400 text-3xl mb-2 group-hover:scale-110 transition-transform">credit_card</span>
                                <span class="text-white font-bold">Webpay / Tarjetas</span>
                                <span class="text-xs text-gray-400 mt-1">Vía Mercado Pago</span>
                            </div>
                            <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity">
                                <span class="material-icons text-gold-500 text-sm">check_circle</span>
                            </div>
                        </label>

                        <!-- Opción CryptoMarket -->
                        <label class="cursor-pointer relative group">
                            <input type="radio" name="metodo_pago" value="CRYPTO" class="peer sr-only">
                            <div
                                class="p-4 rounded-lg border-2 border-gray-700 bg-dark-700 hover:border-gold-500/50 peer-checked:border-gold-500 peer-checked:bg-gold-500/10 transition-all duration-200 flex flex-col items-center">
                                <span
                                    class="material-icons text-orange-400 text-3xl mb-2 group-hover:scale-110 transition-transform">currency_bitcoin</span>
                                <span class="text-white font-bold">Criptomonedas</span>
                                <span class="text-xs text-gray-400 mt-1">Vía CryptoMarket</span>
                            </div>
                            <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity">
                                <span class="material-icons text-gold-500 text-sm">check_circle</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="flex justify-center mt-6">
                    <button type="submit"
                        class="px-6 py-3 bg-gradient-to-r from-gold-400 to-gold-600 text-black font-bold text-lg rounded-md hover:from-gold-500 hover:to-gold-700 shadow-lg hover:shadow-gold-500/20 transition-all w-full sm:w-auto transform hover:scale-[1.02]">
                        Continuar a Pago
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Botón flotante de WhatsApp y mensaje -->
    <div id="whatsapp-label"
        class="fixed bottom-24 right-6 sm:right-10 bg-[#25d366] text-white px-4 py-2 rounded-2xl text-base shadow font-bold z-50">
        Dudas y consultas
    </div>
    <a href="https://wa.me/56928839093?text=Hola%2C%20tengo%20una%20duda%20sobre%20TerraTokenX" target="_blank"
        class="fixed w-14 h-14 bottom-6 right-6 sm:right-10 bg-[#25d366] text-white rounded-full flex items-center justify-center text-3xl shadow z-50"
        title="Contáctanos por WhatsApp">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white" viewBox="0 0 24 24">
            <path
                d="M20.52 3.48A11.93 11.93 0 0 0 12 0C5.37 0 0 5.37 0 12c0 2.11.55 4.16 1.6 5.97L0 24l6.18-1.62A11.93 11.93 0 0 0 12 24c6.63 0 12-5.37 12-12 0-3.19-1.24-6.19-3.48-8.52zM12 22c-1.85 0-3.67-.5-5.23-1.44l-.37-.22-3.67.97.98-3.58-.24-.37A9.94 9.94 0 0 1 2 12c0-5.52 4.48-10 10-10s10 4.48 10 10-4.48 10-10 10zm5.2-7.8c-.28-.14-1.65-.81-1.9-.9-.25-.09-.43-.14-.61.14-.18.28-.7.9-.86 1.08-.16.18-.32.2-.6.07-.28-.14-1.18-.44-2.25-1.4-.83-.74-1.39-1.65-1.55-1.93-.16-.28-.02-.43.12-.57.13-.13.28-.34.42-.51.14-.17.18-.29.28-.48.09-.19.05-.36-.02-.5-.07-.14-.61-1.47-.84-2.01-.22-.53-.45-.46-.61-.47-.16-.01-.36-.01-.56-.01-.19 0-.5.07-.76.36-.26.29-1 1-.97 2.43.03 1.43 1.03 2.81 1.18 3 .15.19 2.02 3.09 4.9 4.21.68.29 1.21.46 1.62.59.68.22 1.3.19 1.79.12.55-.08 1.65-.67 1.88-1.32.23-.65.23-1.21.16-1.32-.07-.11-.25-.18-.53-.32z" />
        </svg>
    </a>
    <!-- Modal Info Popup -->
    <!-- Modal Info Popup (Corner Toast) -->
    <div id="infoModal"
        class="fixed bottom-6 left-6 z-50 invisible opacity-0 transition-all duration-500 transform translate-y-10">

        <!-- Modal Content -->
        <div class="bg-dark-800 border-2 border-gold-500 rounded-xl p-6 max-w-sm shadow-2xl relative" id="modalContent">
            <button onclick="closeModal()"
                class="absolute top-2 right-2 text-gray-500 hover:text-white transition-colors">
                <span class="material-icons text-xl">close</span>
            </button>

            <div class="flex flex-col items-center text-center">
                <div class="bg-gold-500/10 p-3 rounded-full mb-3">
                    <span class="material-icons text-gold-500 text-3xl">info</span>
                </div>

                <h3 class="text-lg font-bold text-white mb-2">Información Importante</h3>

                <p class="text-gray-300 text-sm leading-relaxed mb-4">
                    Al reservar tu cupo, aseguras tu participación en el lanzamiento de
                    <span class="font-bold text-gold-400">TerraTokenX</span>.
                </p>

                <button onclick="closeModal()"
                    class="bg-gold-500 text-black font-bold py-2 px-6 rounded-lg hover:bg-gold-600 transition-colors text-sm shadow-lg">
                    Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Popup Logic & Main Form Logic (Combined at the end) -->
    <script>
        // Modal Logic
        const modal = document.getElementById('infoModal');
        const modalContent = document.getElementById('modalContent');

        function openModal() {
            modal.classList.remove('invisible', 'opacity-0', 'translate-y-10');
        }

        function closeModal() {
            modal.classList.add('opacity-0', 'translate-y-10');
            setTimeout(() => {
                modal.classList.add('invisible');
            }, 500);
        }

        // Auto Open on Load
        window.addEventListener('load', () => {
            setTimeout(openModal, 500); // Small delay for effect
        });

                // Price Calculation & Coupon Logic
        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM loaded - Initializing Price Script");

            // Selectors
            const cantidadInput = document.querySelector('input[name="cantidad_tokens"]');
            const couponInput = document.querySelector('input[name="coupon_code"]');
            const btnValidar = document.getElementById('btn-validar-cupon');
            const couponMessage = document.getElementById('coupon-message');

            const cantidadDisplay = document.getElementById('cantidad-display');
            const precioTotalDisplay = document.getElementById('precio-total');
            const rowDescuento = document.getElementById('row-descuento');
            const discountPercentDisplay = document.getElementById('discount-percent');
            const discountAmountDisplay = document.getElementById('discount-amount');

            // Values
            const precioBase = {{ precio_base_token|stringformat:"d" }};
            let currentDiscountPercent = 0;

            console.log("Base Price:", precioBase);
            console.log("Cantidad Input:", cantidadInput);

            function formatCurrency(amount) {
                return ' + Math.round(amount).toLocaleString('es-CL');
            }

            function actualizarTotal() {
                let cantidad = parseInt(cantidadInput.value) || 1;
                if (cantidad < 1) {
                    cantidad = 1;
                    cantidadInput.value = 1;
                }

                console.log("Updating Total. Quantity:", cantidad, "Discount:", currentDiscountPercent);

                if (cantidadDisplay) cantidadDisplay.textContent = cantidad;

                const subtotal = precioBase * cantidad;
                let discountAmount = 0;

                if (currentDiscountPercent > 0) {
                    discountAmount = (subtotal * currentDiscountPercent) / 100;

                    if (rowDescuento) {
                        rowDescuento.classList.remove('hidden');
                        if (discountPercentDisplay) discountPercentDisplay.textContent = currentDiscountPercent;
                        if (discountAmountDisplay) discountAmountDisplay.textContent = '-' + formatCurrency(discountAmount);
                    }
                } else {
                    if (rowDescuento) rowDescuento.classList.add('hidden');
                }

                const total = subtotal - discountAmount;
                if (precioTotalDisplay) precioTotalDisplay.textContent = formatCurrency(total);
            }

            // Event Listeners for Quantity
            if (cantidadInput) {
                cantidadInput.addEventListener('input', actualizarTotal);
                cantidadInput.addEventListener('change', actualizarTotal);
                // Also trigger initially
                actualizarTotal();
            } else {
                console.error("Critical: Quantity input not found!");
            }

            // Coupon Validation Logic
            if (btnValidar) {
                btnValidar.addEventListener('click', function () {
                    console.log("Validating coupon...");
                    const code = couponInput.value.trim();
                    if (!code) {
                        couponMessage.textContent = "Ingresa un codigo primero.";
                        couponMessage.className = "text-red-500 block mt-1 h-5";
                        return;
                    }

                    btnValidar.disabled = true;
                    btnValidar.textContent = "...";

                    fetch('{% url "validate_coupon" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ code: code })
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log("Coupon Response:", data);
                            btnValidar.disabled = false;
                            btnValidar.textContent = "Validar";

                            if (data.valid) {
                                currentDiscountPercent = data.discount_percentage;
                                couponMessage.textContent = "Cupon valido! " + data.discount_percentage + "% descuento";
                                couponMessage.className = "text-green-400 block mt-1 h-5 font-medium";
                                actualizarTotal();
                            } else {
                                currentDiscountPercent = 0;
                                couponMessage.textContent = data.message || "Cupon invalido";
                                couponMessage.className = "text-red-500 block mt-1 h-5";
                                actualizarTotal();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching coupon:', error);
                            btnValidar.disabled = false;
                            btnValidar.textContent = "Validar";
                            couponMessage.textContent = "Error al validar el cupon.";
                            couponMessage.className = "text-red-500 block mt-1 h-5";
                        });
                });
            }
        });
    </script>
</body>

</html>