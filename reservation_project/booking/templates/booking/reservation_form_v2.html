{% load static humanize %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>TerraTokenx-Compra token lanzamiento</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: {
                            400: '#E5C453',
                            500: '#D4AF37',
                            600: '#B5952F',
                        },
                        dark: {
                            800: '#121212',
                            900: '#050505',
                            card: '#1e1e1e'
                        }
                    }
                }
            }
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Custom Scrollbar for Dark Theme */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #D4AF37;
        }

        /* General Input Styling for Dark Mode */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            background-color: #121212 !important;
            border: 1px solid #333 !important;
            color: #f3f4f6 !important;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #D4AF37 !important;
            outline: none;
            box-shadow: 0 0 0 1px #D4AF37;
        }

        /* Specific override if needed for coupon, though general rule covers it */
        input[name="coupon_code"] {
            border-color: #D4AF37 !important;
        }
    </style>
    <script>
        function formatearCLP(valor) {
            return '$' + valor.toLocaleString('es-CL');
        }
    </script>
</head>

<body class="text-gray-100 font-sans antialiased selection:bg-gold-500 selection:text-black"
    style="background: linear-gradient(to top right, #000000, #374151); min-height: 100vh;">

    <!-- Icono de acceso para administradores -->


    <div class="container mx-auto px-2 py-6 sm:px-4 sm:py-8 max-w-3xl">
        <!-- Mensaje Importante -->

        <div class="flex flex-col items-center justify-center mb-6">
            <img src="{% static 'booking/img/Terratoken_logo-removebg-preview2.png' %}" alt="TerraTokenX Logo"
                class="w-72 sm:w-80 h-auto object-contain mb-2">
            <p class="text-gray-500 text-xs sm:text-sm uppercase tracking-widest font-medium">Real Assets. Digital
                Trust</p>
        </div>
        <!-- Mensaje para el usuario -->
        <div id="mensaje-usuario" style="display:none;"
            class="mb-4 text-center px-4 py-2 bg-red-900 text-red-100 border border-red-700 rounded"></div>
        {% if messages %}
        <ul>
            {% for message in messages %}
            <li class="text-red-400 mb-2">{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        <!-- Formulario centrado -->
        <div class="bg-dark-800 p-4 sm:p-6 rounded-lg shadow-2xl border border-gray-800 max-w-lg mx-auto w-full">
            <form id="reserva-form" method="post" novalidate>
                <!-- Formulario de Reserva v2.1 - Patched -->
                {% csrf_token %}
                {{ form.proyecto }}

                <!-- SELECTOR DE PROYECTO (DROPDOWN) -->
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-300 mb-3">Selecciona el Proyecto</label>
                    <div class="relative">
                        <select id="project_select_dropdown"
                            class="w-full bg-dark-800 border border-gray-600 text-white rounded-lg p-3 appearance-none focus:border-gold-500 focus:ring-1 focus:ring-gold-500 transition-colors cursor-pointer">
                            <option value="" disabled {% if not proyecto %}selected{% endif %}>-- Elige un proyecto --
                            </option>
                                                        {% for p in proyectos_activos %}
                            <option value="{{ p.id }}" 
                                    data-price="{{ p.precio_token }}"
                                    data-stock="{{ p.tokens_disponibles|stringformat:'d' }}" 
                                    data-name="{{ p.nombre }}"
                                    data-img="{% if p.imagen_portada_url %}{{ p.imagen_portada_url }}{% elif p.imagen_portada %}{{ p.imagen_portada.url }}{% endif %}"
                                    {% if proyecto and proyecto.id == p.id %}selected{% endif %}>
                                {{ p.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                            <span class="material-icons">expand_more</span>
                        </div>
                    </div>

                    <!-- Info del proyecto seleccionado (Visible al seleccionar) -->
                    <div id="project-info-card"
                        class="mt-4 hidden p-4 rounded-xl border border-gray-700 bg-dark-800 flex items-center gap-4 transition-all">
                        <div
                            class="w-16 h-16 rounded-lg bg-gray-800 border border-gray-600 overflow-hidden flex-shrink-0">
                            <img id="selected-project-img" src="" alt="" class="w-full h-full object-cover hidden">
                            <div id="selected-project-placeholder"
                                class="flex items-center justify-center h-full text-gray-500 text-xs text-center p-1">
                                Vista Previa
                            </div>
                        </div>
                        <div class="flex-1">
                            <h4 id="selected-project-name" class="text-white font-bold leading-tight">Proyecto</h4>
                            <p class="text-xs text-gray-400 mt-1">Precio Token: <span id="selected-project-price"
                                    class="text-gold-400 font-bold">$0 USD</span></p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Nombre completo*</label>
                        {{ form.nombre }}
                        {{ form.nombre.errors }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Correo electr√≥nico*</label>
                        {{ form.correo }}
                        {{ form.correo.errors }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Tel√©fono* <span
                                class="text-xs text-gray-500">(para recibir el contrato)</span></label>
                        {{ form.telefono }}
                        {{ form.telefono.errors }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">RUT* <span
                                class="text-xs text-gray-500">(obligatorio para contrato)</span></label>
                        {{ form.rut }}
                        {{ form.rut.errors }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Direcci√≥n*</label>
                        {{ form.direccion }}
                        {{ form.direccion.errors }}
                    </div>

                    <!-- Secci√≥n Persona Jur√≠dica -->
                    <div class="pt-4 border-t border-gray-700">
                        <div class="flex items-center mb-4">
                            {{ form.es_empresa }}
                            <label for="check_es_empresa" class="ml-2 text-sm font-medium text-gray-300 cursor-pointer">
                                Comprar como Empresa (Persona Jur√≠dica)
                            </label>
                        </div>

                        <div id="company-fields" class="space-y-4 pl-4 border-l-2 border-slate-600 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Raz√≥n Social</label>
                                {{ form.razon_social }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">RUT Empresa</label>
                                {{ form.rut_empresa }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-1">Cargo Que Firma</label>
                                {{ form.cargo_representante }}
                                <span class="text-xs text-gray-500 block">Ej: Representante Legal, Gerente
                                    General</span>
                            </div>
                        </div>
                    </div>

                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const checkEmpresa = document.getElementById('check_es_empresa');
                            const companyFields = document.getElementById('company-fields');

                            function toggleCompanyFields() {
                                if (checkEmpresa.checked) {
                                    companyFields.classList.remove('hidden');
                                } else {
                                    companyFields.classList.add('hidden');
                                }
                            }

                            checkEmpresa.addEventListener('change', toggleCompanyFields);
                            // Initial check
                            toggleCompanyFields();
                        });
                    </script>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">C√≥digo de Cup√≥n</label>
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-gold-500">local_offer</span>
                            <div class="flex-1">
                                {{ form.coupon_code }}
                                {{ form.coupon_code.errors }}
                            </div>
                            <button type="button" id="btn-validar-cupon"
                                class="px-3 py-2 bg-dark-800 border border-gold-500 text-gold-500 rounded hover:bg-gold-500 hover:text-black transition-colors text-sm font-bold">
                                Validar
                            </button>
                        </div>
                        <small id="coupon-message" class="text-gray-500 block mt-1 h-5"></small>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Cantidad de Tokens</label>
                        {{ form.cantidad_tokens }}
                        <small id="stock-info" class="text-gray-500 block mt-1"></small>
                        {{ form.cantidad_tokens.errors }}
                    </div>
                </div>

                <!-- Secci√≥n de Precios Mejorada -->
                <div id="precio-info" class="mt-6 bg-dark-800 border border-gray-700 p-4 rounded-lg">
                    <div class="flex justify-between items-center text-sm mb-1 text-gray-400">
                        <span id="precio-dia-label">Valor del Token</span>
                        <span class="font-semibold text-gray-300">${{ precio_base_token }} USD</span>
                    </div>
                    <div class="flex justify-between items-center text-sm mb-1 text-gray-400">
                        <span>Cantidad</span>
                        <span id="cantidad-display" class="font-semibold text-gray-300">1</span>
                    </div>

                    <!-- Fila de Descuento (Oculta por defecto) -->
                    <div id="row-descuento"
                        class="flex justify-between items-center text-sm mb-1 text-green-400 hidden">
                        <span>Descuento (<span id="discount-percent">0</span>%)</span>
                        <span id="discount-amount" class="font-semibold">-$0</span>
                    </div>

                    <!-- Fila de Comisi√≥n (Oculta por defecto) -->
                    <div id="row-comision" class="flex justify-between items-center text-sm mb-1 text-gray-400 hidden">
                        <span>Comisi√≥n Mercado Pago (3,19% + IVA)</span>
                        <span id="comision-amount" class="font-semibold text-gray-300">+$0</span>
                    </div>

                    <div
                        class="flex justify-between items-center text-lg font-bold text-gold-400 mt-2 border-t border-gray-600 pt-2">
                        <span>Total a Pagar</span>
                        <span id="precio-total">${{ precio_base_token }} USD</span>
                    </div>
                </div>



                <!-- Selector de Medio de Pago -->
                <div class="mt-8 mb-6">
                    <h3 class="text-lg font-semibold text-gold-400 mb-4 border-b border-gray-700 pb-2">Selecciona
                        M√©todo
                        de Pago</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Opci√≥n Mercado Pago -->
                        <label class="cursor-pointer relative group">
                            <input type="radio" name="metodo_pago" value="MP" class="peer sr-only">
                            <div
                                class="p-4 rounded-lg border-2 border-gray-700 bg-dark-800 hover:border-gold-500/50 peer-checked:border-gold-500 peer-checked:bg-gold-500/10 transition-all duration-200 flex flex-col items-center">
                                <span
                                    class="material-icons text-blue-400 text-3xl mb-2 group-hover:scale-110 transition-transform">credit_card</span>
                                <span class="text-white font-bold">Tarjetas</span>
                                <span class="text-xs text-gray-400 mt-1">V√≠a Mercado Pago</span>
                                <span
                                    class="mt-2 px-2 py-0.5 bg-yellow-500/20 text-yellow-400 text-[10px] font-bold uppercase tracking-wider rounded border border-yellow-500/50">
                                    Comisi√≥n 3,19% + IVA
                                </span>
                            </div>
                            <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity">
                                <span class="material-icons text-gold-500 text-sm">check_circle</span>
                            </div>
                        </label>

                        <!-- Opci√≥n CryptoMarket -->
                        <label class="cursor-pointer relative group">
                            <input type="radio" name="metodo_pago" value="CRYPTO" class="peer sr-only" checked>
                            <div
                                class="p-4 rounded-lg border-2 border-gray-700 bg-dark-800 hover:border-gold-500/50 peer-checked:border-gold-500 peer-checked:bg-gold-500/10 transition-all duration-200 flex flex-col items-center">
                                <span
                                    class="material-icons text-orange-400 text-3xl mb-2 group-hover:scale-110 transition-transform">currency_bitcoin</span>
                                <span class="text-white font-bold">Criptomonedas</span>
                                <span class="text-xs text-gray-400 mt-1">V√≠a CryptoMarket</span>
                            </div>
                            <div class="absolute top-2 right-2 opacity-0 peer-checked:opacity-100 transition-opacity">
                                <span class="material-icons text-gold-500 text-sm">check_circle</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="flex justify-center mt-6">
                    <button type="submit"
                        class="px-6 py-3 bg-gradient-to-r from-gold-400 to-gold-600 text-black font-bold text-lg rounded-md hover:from-gold-500 hover:to-gold-700 shadow-lg hover:shadow-gold-500/20 transition-all w-full sm:w-auto transform hover:scale-[1.02]">
                        Continuar a Pago
                    </button>
                </div>
            </form>
        </div>

        <!-- Bot√≥n flotante "Saber m√°s" -->
        <button onclick="openPromoPanel()"
            class="fixed top-1/2 -translate-y-1/2 right-0 bg-gold-500 text-black font-bold py-3 px-2 rounded-l-lg shadow-lg hover:bg-gold-600 transition-all z-40 flex items-center gap-1 writing-mode-vertical"
            style="writing-mode: vertical-rl; text-orientation: mixed;">
            <span class="material-icons text-sm">info</span>
            Saber m√°s y ver proyectos
        </button>

        <!-- Panel deslizante desde la derecha -->
        <div id="promoPanel"
            class="fixed top-0 right-0 h-full w-full sm:w-96 bg-dark-800 border-l-2 border-gold-500 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">

            <!-- Bot√≥n cerrar -->
            <button onclick="closePromoPanel()"
                class="absolute top-4 left-4 text-gray-400 hover:text-white transition-colors">
                <span class="material-icons text-2xl">close</span>
            </button>

            <div class="p-6 pt-16">
                <!-- Headline -->
                <div class="mb-6">
                    <span class="text-3xl mb-3 block">üéØ</span>
                    <h2 class="text-xl font-bold text-gold-400 leading-tight mb-4 text-justify">
                        Acceso exclusivo por tiempo limitado al precio de pre-venta para miembros fundadores de la
                        Comunidad V.I.P. de TerraTokenX.
                    </h2>
                </div>

                <!-- Subheadline -->
                <div class="border-t border-gray-700 pt-4 mb-6">
                    <p class="text-gray-300 text-sm leading-relaxed">
                        <span class="inline-block mr-2">‚ú®</span> Cupos limitados ¬∑ Acceso preferente ¬∑ Participaci√≥n
                        temprana en el ecosistema TerraTokenX.
                    </p>
                </div>

                <!-- CTA -->
                <div
                    class="bg-gradient-to-r from-gold-500/10 to-gold-600/10 border border-gold-500/40 rounded-lg p-4 mb-6">
                    <p class="text-white font-semibold text-center text-sm">
                        üöÄ <span class="text-gold-400">Compra tu TOKEN de Pre-Venta</span> y obtendr√°s acceso autom√°tico
                        a <span class="font-bold text-gold-400">#VIPTTX</span>
                    </p>
                </div>

                <!-- Badges -->
                <div class="flex flex-wrap justify-center gap-3">
                    <span
                        class="px-3 py-1 bg-green-900/30 text-green-400 text-xs font-bold rounded-full border border-green-700">
                        ‚úì Cupos Limitados
                    </span>
                    <span
                        class="px-3 py-1 bg-blue-900/30 text-blue-400 text-xs font-bold rounded-full border border-blue-700">
                        ‚úì Acceso VIP
                    </span>
                    <span
                        class="px-3 py-1 bg-purple-900/30 text-purple-400 text-xs font-bold rounded-full border border-purple-700">
                        ‚úì Miembro Fundador
                    </span>
                </div>

                <!-- Bot√≥n Proyectos Fraccionados -->
                <div class="mt-8 text-center">
                    <a href="https://darkorchid-albatross-663962.hostingersite.com/" target="_blank"
                        class="inline-block px-6 py-3 bg-gray-800 border border-gold-500 text-gold-500 font-bold rounded-lg hover:bg-gold-500 hover:text-black transition-all shadow-lg hover:shadow-gold-500/20 transform hover:scale-105">
                        <span class="flex items-center gap-2">
                            <span class="material-icons">apartment</span>
                            Ver Proyectos Tokenizados
                        </span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Overlay oscuro -->
        <div id="promoOverlay" onclick="closePromoPanel()" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

        <!-- Bot√≥n flotante de WhatsApp y mensaje -->
        <a href="https://wa.me/56928839093?text=Hola%2C%20tengo%20una%20duda%20sobre%20TerraTokenX" target="_blank"
            class="fixed w-14 h-14 bottom-6 right-6 sm:right-10 bg-[#25d366] text-white rounded-full flex items-center justify-center text-3xl shadow z-50"
            title="Cont√°ctanos por WhatsApp">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="white" viewBox="0 0 24 24">
                <path
                    d="M20.52 3.48A11.93 11.93 0 0 0 12 0C5.37 0 0 5.37 0 12c0 2.11.55 4.16 1.6 5.97L0 24l6.18-1.62A11.93 11.93 0 0 0 12 24c6.63 0 12-5.37 12-12 0-3.19-1.24-6.19-3.48-8.52zM12 22c-1.85 0-3.67-.5-5.23-1.44l-.37-.22-3.67.97.98-3.58-.24-.37A9.94 9.94 0 0 1 2 12c0-5.52 4.48-10 10-10s10 4.48 10 10-4.48 10-10 10zm5.2-7.8c-.28-.14-1.65-.81-1.9-.9-.25-.09-.43-.14-.61.14-.18.28-.7.9-.86 1.08-.16.18-.32.2-.6.07-.28-.14-1.18-.44-2.25-1.4-.83-.74-1.39-1.65-1.55-1.93-.16-.28-.02-.43.12-.57.13-.13.28-.34.42-.51.14-.17.18-.29.28-.48.09-.19.05-.36-.02-.5-.07-.14-.61-1.47-.84-2.01-.22-.53-.45-.46-.61-.47-.16-.01-.36-.01-.56-.01-.19 0-.5.07-.76.36-.26.29-1 1-.97 2.43.03 1.43 1.03 2.81 1.18 3 .15.19 2.02 3.09 4.9 4.21.68.29 1.21.46 1.62.59.68.22 1.3.19 1.79.12.55-.08 1.65-.67 1.88-1.32.23-.65.23-1.21.16-1.32-.07-.11-.25-.18-.53-.32z" />
            </svg>
        </a>
        <!-- Modal Info Popup -->
        <!-- Modal Info Popup (Corner Toast) -->
        <div id="infoModal"
            class="fixed bottom-6 left-6 z-50 invisible opacity-0 transition-all duration-500 transform translate-y-10">

            <!-- Modal Content -->
            <div class="bg-dark-800 border-2 border-gold-500 rounded-xl p-6 max-w-sm shadow-2xl relative"
                id="modalContent">
                <button onclick="closeModal()"
                    class="absolute top-2 right-2 text-gray-500 hover:text-white transition-colors">
                    <span class="material-icons text-xl">close</span>
                </button>

                <div class="flex flex-col items-center text-center">
                    <div class="bg-gold-500/10 p-3 rounded-full mb-3">
                        <span class="material-icons text-gold-500 text-3xl">info</span>
                    </div>

                    <h3 class="text-lg font-bold text-white mb-2">Informaci√≥n Importante</h3>

                    <p class="text-gray-300 text-sm leading-relaxed mb-4">
                        SI QUIERES SABER M√ÅS SOBRE NUESTRA PLATAFORMA, √öNETE A LA PRIMERA COMUNIDAD DE INVERSIONISTAS
                        TOKENIZACI√ìN DE TERRENOS DE LATAM Y NO TE PIERDAS NUESTRO LANZAMIENTO!!üöÄ
                    </p>

                    <a href="https://chat.whatsapp.com/G7aHCdj9v6RAY8xRrbrjkn" target="_blank"
                        class="bg-[#d1a841] text-black font-bold py-2 px-6 rounded-lg hover:bg-[#b69237] transition-colors text-sm shadow-lg flex items-center gap-2">
                        <span class="material-icons text-lg">groups</span>
                        Unirme a Comunidad
                    </a>
                </div>
            </div>
        </div>

        <!-- Modal Popup Logic & Main Form Logic (Combined at the end) -->
        <script>
            // Modal Logic
            const modal = document.getElementById('infoModal');
            const modalContent = document.getElementById('modalContent');

            function openModal() {
                modal.classList.remove('invisible', 'opacity-0', 'translate-y-10');
            }

            function closeModal() {
                modal.classList.add('opacity-0', 'translate-y-10');
                setTimeout(() => {
                    modal.classList.add('invisible');
                }, 500);
            }

            // Auto Open on Load
            window.addEventListener('load', () => {
                setTimeout(openModal, 500); // Small delay for effect
            });

            // Promo Panel Logic
            const promoPanel = document.getElementById('promoPanel');
            const promoOverlay = document.getElementById('promoOverlay');

            function openPromoPanel() {
                promoPanel.classList.remove('translate-x-full');
                promoOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closePromoPanel() {
                promoPanel.classList.add('translate-x-full');
                promoOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            }

            // Price Calculation & Coupon Logic
            document.addEventListener('DOMContentLoaded', function () {
                console.log("DOM loaded - Initializing Price Script");

                // Selectors
                const cantidadInput = document.querySelector('input[name="cantidad_tokens"]');
                const couponInput = document.querySelector('input[name="coupon_code"]');
                const btnValidar = document.getElementById('btn-validar-cupon');
                const couponMessage = document.getElementById('coupon-message');

                const cantidadDisplay = document.getElementById('cantidad-display');
                const precioTotalDisplay = document.getElementById('precio-total');
                const precioDiaLabel = document.getElementById('precio-dia-label'); // Label para actualizar el precio del token
                const rowDescuento = document.getElementById('row-descuento');
                const discountPercentDisplay = document.getElementById('discount-percent');
                const discountAmountDisplay = document.getElementById('discount-amount');
                const rowComision = document.getElementById('row-comision');
                const comisionAmountDisplay = document.getElementById('comision-amount');
                const radioButtons = document.querySelectorAll('input[name="metodo_pago"]');

                // Values
                let precioBase = parseFloat("{{ precio_base_token|default:'0' }}") || 0;
                let currentDiscountPercent = 0;

                console.log("Initial Base Price:", precioBase);

                // Dropdown and UI Elements
                const projectDropdown = document.getElementById('project_select_dropdown');
                const projectInfoCard = document.getElementById('project-info-card');
                const selectedProjectImg = document.getElementById('selected-project-img');
                const selectedProjectPlaceholder = document.getElementById('selected-project-placeholder');
                const selectedProjectName = document.getElementById('selected-project-name');
                const selectedProjectPrice = document.getElementById('selected-project-price');

                function handleProjectSelection() {
                    const selectedOption = projectDropdown.options[projectDropdown.selectedIndex];
                    const id = selectedOption.value;

                    if (!id) {
                        projectInfoCard.classList.add('hidden');
                        precioBase = parseInt("{{ precio_base_token|default:0 }}".replace(/\D/g, '')) || 0;
                        actualizarTotal();
                        return;
                    }

                    const price = selectedOption.getAttribute('data-price');
                    const name = selectedOption.getAttribute('data-name');
                    const imgUrl = selectedOption.getAttribute('data-img');
                    const stock = selectedOption.getAttribute('data-stock');

                    // Update Hidden Input
                    const hiddenInput = document.getElementById('id_proyecto');
                    if (hiddenInput) hiddenInput.value = id;

                    // Update UI Card
                    projectInfoCard.classList.remove('hidden');
                    if (selectedProjectName) selectedProjectName.textContent = name;
                    if (selectedProjectPrice) {
                        const p = parseFloat(price) || 0;
                        selectedProjectPrice.textContent = '$' + p.toFixed(2) + ' USD';
                    }

                    if (imgUrl && imgUrl.trim() !== "") {
                        selectedProjectImg.src = imgUrl;
                        selectedProjectImg.classList.remove('hidden');
                        selectedProjectPlaceholder.classList.add('hidden');
                    } else {
                        selectedProjectImg.classList.add('hidden');
                        selectedProjectPlaceholder.classList.remove('hidden');
                    }

                    // Stock Logic
                    const stockInfo = document.getElementById('stock-info');
                    if (stock) {
                        const available = parseInt(stock);
                        if (cantidadInput) {
                            cantidadInput.max = available;
                            // Reset if current value exceeds new availability
                            if (parseInt(cantidadInput.value) > available) {
                                cantidadInput.value = available;
                            }
                        }
                        if (stockInfo) {
                            stockInfo.textContent = `Disponibles: ${available} tokens`;
                            stockInfo.className = available < 10 ? "text-red-400 block mt-1 font-bold" : "text-gray-500 block mt-1";
                        }
                    }

                    // Update Price Logic
                    precioBase = parseFloat(price) || 0;
                    console.log("Project Selected via Dropdown:", name, "Price:", precioBase, "Stock:", stock);

                    // Update UI Unit Price Text
                    if (precioDiaLabel) {
                        const priceSpan = precioDiaLabel.nextElementSibling;
                        if (priceSpan) priceSpan.textContent = '$' + precioBase + ' USD';
                    }

                    actualizarTotal();
                }

                if (projectDropdown) {
                    projectDropdown.addEventListener('change', handleProjectSelection);
                    // Initialize if there is a pre-selected value
                    if (projectDropdown.value) {
                        handleProjectSelection();
                    }
                }

                function formatCurrency(amount) {
                    return '$' + Math.round(amount) + ' USD';
                }

                function actualizarTotal() {
                    let cantidad = parseInt(cantidadInput.value) || 1;
                    if (cantidad < 1) {
                        cantidad = 1;
                        cantidadInput.value = 1;
                    }

                    // Ensure a project is selected if strictly required, or handle default
                    // For now, if precioBase is 0 (no project selected and no default), total is 0

                    console.log("Updating Total. Quantity:", cantidad, "Price:", precioBase);

                    if (cantidadDisplay) cantidadDisplay.textContent = cantidad;

                    const subtotal = precioBase * cantidad;
                    let discountAmount = 0;

                    if (currentDiscountPercent > 0) {
                        discountAmount = (subtotal * currentDiscountPercent) / 100;

                        if (rowDescuento) {
                            rowDescuento.classList.remove('hidden');
                            if (discountPercentDisplay) discountPercentDisplay.textContent = currentDiscountPercent;
                            if (discountAmountDisplay) discountAmountDisplay.textContent = '-' + formatCurrency(discountAmount);
                        }
                    } else {
                        if (rowDescuento) rowDescuento.classList.add('hidden');
                    }

                    let total = subtotal - discountAmount;

                    // L√≥gica para calcular comisi√≥n MP
                    const metodoPago = document.querySelector('input[name="metodo_pago"]:checked').value;
                    let commissionAmount = 0;

                    if (metodoPago === 'MP') {
                        commissionAmount = total * 0.0319;
                        if (rowComision) {
                            rowComision.classList.remove('hidden');
                            if (comisionAmountDisplay) comisionAmountDisplay.textContent = '+' + formatCurrency(commissionAmount);
                        }
                    } else {
                        if (rowComision) rowComision.classList.add('hidden');
                    }

                    total += commissionAmount;

                    if (precioTotalDisplay) precioTotalDisplay.textContent = formatCurrency(total);
                }

                // Event Listeners for Payment Method Logic
                if (radioButtons) {
                    radioButtons.forEach(radio => {
                        radio.addEventListener('change', actualizarTotal);
                    });
                }

                // Event Listeners for Quantity
                if (cantidadInput) {
                    cantidadInput.addEventListener('input', actualizarTotal);
                    cantidadInput.addEventListener('change', actualizarTotal);
                    actualizarTotal();
                } else {
                    console.error("Critical: Quantity input not found!");
                }

                // Coupon Validation Logic
                if (btnValidar) {
                    btnValidar.addEventListener('click', function () {
                        console.log("Validating coupon...");
                        const code = couponInput.value.trim();
                        if (!code) {
                            couponMessage.textContent = "Ingresa un codigo primero.";
                            couponMessage.className = "text-red-500 block mt-1 h-5";
                            return;
                        }

                        btnValidar.disabled = true;
                        btnValidar.textContent = "...";

                        fetch('{% url "validate_coupon" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({ code: code })
                        })
                            .then(response => response.json())
                            .then(data => {
                                console.log("Coupon Response:", data);
                                btnValidar.disabled = false;
                                btnValidar.textContent = "Validar";

                                if (data.valid) {
                                    currentDiscountPercent = data.discount_percentage;
                                    couponMessage.textContent = "Cupon valido! " + data.discount_percentage + "% descuento";
                                    couponMessage.className = "text-green-400 block mt-1 h-5 font-medium";
                                    actualizarTotal();
                                } else {
                                    currentDiscountPercent = 0;
                                    couponMessage.textContent = data.message || "Cupon invalido";
                                    couponMessage.className = "text-red-500 block mt-1 h-5";
                                    actualizarTotal();
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching coupon:', error);
                                btnValidar.disabled = false;
                                btnValidar.textContent = "Validar";
                                couponMessage.textContent = "Error al validar el cupon.";
                                couponMessage.className = "text-red-500 block mt-1 h-5";
                            });
                    });
                }
            });
        </script>
</body>

</html>
